{% extends 'base.html' %}

{% block content %}
<h1>Pflegetagebuch für {{ plant.name }}</h1>

    <!-- Anzeige der Pflanzendetails -->
    <div class="plant-details">
        <p><strong>Name:</strong> {{ plant.name }}</p>
        <p><strong>Beschreibung:</strong> {{ plant.description }}</p>
        <p><strong>Bild-URL:</strong> <a href="{{ plant.image_url }}" target="_blank">Bild ansehen</a></p>
        <p><strong>Sonnenlicht:</strong> {{ plant.sunlight }}</p>
        <p><strong>Wasserbedarf:</strong> {{ plant.water_needs }}</p>
        <p><strong>Temperaturbereich:</strong> {{ plant.temperature_range }}</p>
        <p><strong>Status:</strong> {{ plant.status }}</p>
    </div>

    <!-- Button to trigger the modal -->
    <button class="button is-primary" id="addEntryButton">Add Entry</button>

    <!-- Modal -->
    <div class="modal" id="addEntryModal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Add Entry</p>
                <button class="delete" aria-label="close" id="closeModal"></button>
            </header>
            <section class="modal-card-body">
                <!-- Form inputs for care journal entry -->
                <form id="entryForm" method="POST" action="{{ url_for('add_entry', plant_id=plant_id) }}" enctype="multipart/form-data">
                    <div class="field">
                        <label class="label">Date</label>
                        <div class="control">
                            <input class="input" type="date" id="entry_date" name="entry_date" required>
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Notes</label>
                        <div class="control">
                            <textarea class="textarea" id="notes" name="notes" placeholder="Enter notes" required></textarea>
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Image Upload</label>
                        <div class="control">
                            <input class="input" type="file" id="image" name="image" accept="image/*">
                        </div>
                    </div>
                </form>
            </section>
            
            <footer class="modal-card-foot">
                <button class="button is-primary" id="submitEntry">Submit</button>
                <button class="button" id="cancelEntry">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Care Journal Entries Table -->
    <table class="table is-fullwidth is-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Notes</th>
                <th>Image</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in care_journal_entries %}
            <tr>
                <td>{{ entry.entry_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ entry.notes }}</td>
                <td>
                    {% if entry.images %}
                        <img src="{{ url_for('static', filename=entry.images[0]) }}" alt="Plant Image" style="width: 100px; height: auto;">
                    {% else %}
                        No Image
                    {% endif %}
                </td>
                <td>
                    <button class="button is-warning update-button" data-id="{{ entry._id }}"><i class="fas fa-edit"></i></button>
                    <button class="button is-danger deactivate-button" data-id="{{ entry._id }}"><i class="fas fa-times"></i></button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3">Keine Einträge gefunden.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        // Modal interaction
        document.getElementById('addEntryButton').addEventListener('click', function() {
            document.getElementById('addEntryModal').classList.add('is-active');
        });
        
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('addEntryModal').classList.remove('is-active');
        });

        document.getElementById('submitEntry').addEventListener('click', function() {
            document.getElementById('entryForm').submit();
        });

        document.getElementById('cancelEntry').addEventListener('click', function() {
            document.getElementById('addEntryModal').classList.remove('is-active');
        });

        document.addEventListener('DOMContentLoaded', function() {
        // Modal zum Update öffnen oder direkt Update Formular anzeigen
        const updateButtons = document.querySelectorAll('.update-button');
        updateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const entryId = this.getAttribute('data-id');
                alert('Update für Eintrag ID ' + entryId);  // Beispiel-Implementierung
            });
        });

        // Deaktivieren des Eintrags
        const deactivateButtons = document.querySelectorAll('.deactivate-button');
        deactivateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const entryId = this.getAttribute('data-id');
                if (confirm('Möchten Sie diesen Eintrag wirklich deaktivieren?')) {
                    fetch(`/deactivate-entry/${entryId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.reload();  // Seite neu laden, um die Änderungen anzuzeigen
                        } else {
                            alert('Fehler: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Fehler beim Deaktivieren des Eintrags:', error);
                    });
                }
            });
        });
    });


    </script>
{% endblock %}
